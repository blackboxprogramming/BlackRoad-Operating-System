name: Validate Deployment Configuration

on:
  pull_request:
    branches: [main]
    paths:
      - 'railway.toml'
      - 'backend/.env.example'
      - 'ops/domains.yaml'
      - 'DEPLOYMENT_ARCHITECTURE.md'
      - 'TEMPORARY_DEPLOYMENT.md'
      - 'scripts/validate_deployment_config.py'
      - '.github/workflows/validate-deployment-config.yml'
  push:
    branches: [main]
    paths:
      - 'railway.toml'
      - 'backend/.env.example'
      - 'ops/domains.yaml'

jobs:
  validate:
    name: Validate Deployment Config
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Run deployment validation
        id: validate
        run: |
          python scripts/validate_deployment_config.py
        continue-on-error: true

      - name: Check validation result
        run: |
          if [ ${{ steps.validate.outcome }} == 'failure' ]; then
            echo "::error::Deployment configuration validation failed"
            echo "See the validation output above for details"
            exit 1
          elif [ ${{ steps.validate.outcome }} == 'success' ]; then
            echo "::notice::Deployment configuration validation passed"
          fi

      - name: Check for monorepo deployment without temporary marker
        if: always()
        run: |
          if grep -q "BlackRoad-Operating-System" railway.toml && ! grep -qi "temporary" railway.toml; then
            echo "::error file=railway.toml::Monorepo deployment detected without 'temporary' marker"
            echo "::error::If deploying monorepo permanently, see DEPLOYMENT_ARCHITECTURE.md"
            exit 1
          fi

      - name: Check for migration plan
        if: always()
        run: |
          if grep -qi "temporary" railway.toml; then
            if [ ! -f "TEMPORARY_DEPLOYMENT.md" ] && [ ! -f "MIGRATION_TO_SATELLITES.md" ]; then
              echo "::warning file=railway.toml::Temporary deployment detected but no migration plan found"
              echo "::warning::Consider creating TEMPORARY_DEPLOYMENT.md with migration timeline"
            else
              echo "::notice::Migration plan documentation exists"
            fi
          fi

      - name: Comment on PR (if validation failed)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ⚠️ Deployment Configuration Validation Failed

            The deployment configuration validation has detected issues with this PR.

            ### Common Issues

            1. **Monorepo deployed without temporary marker**
               - Ensure \`railway.toml\` includes "temporary" if deploying monorepo
               - See \`DEPLOYMENT_ARCHITECTURE.md\` for target architecture

            2. **Hardcoded monorepo URLs**
               - Use satellite URLs instead: \`blackroad-os-core-production.up.railway.app\`
               - Temporary monorepo URLs in \`ALLOWED_ORIGINS\` are OK (with warning)

            3. **Missing migration plan**
               - If deploying monorepo temporarily, create \`TEMPORARY_DEPLOYMENT.md\`
               - Include migration timeline to satellite architecture

            ### How to Fix

            1. Review the validation output above
            2. Fix the issues locally
            3. Run \`python scripts/validate_deployment_config.py\` to verify
            4. Push the fixes

            ### Need Help?

            - See \`DEPLOYMENT_ARCHITECTURE.md\` for deployment model
            - See \`TEMPORARY_DEPLOYMENT.md\` for temporary deployment guidelines
            - Ask in \`#infrastructure\` Slack channel

            ---
            <sub>This comment was automatically generated by the deployment validation workflow.</sub>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on PR (if validation passed)
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ✅ Deployment Configuration Validation Passed

            Deployment configuration looks good!

            ${
              // Check if temporary deployment
              require('fs').readFileSync('railway.toml', 'utf8').toLowerCase().includes('temporary')
                ? `⚠️ **Note**: This PR includes a temporary monorepo deployment. Ensure migration plan is documented in \`TEMPORARY_DEPLOYMENT.md\`.`
                : ''
            }

            ---
            <sub>This comment was automatically generated by the deployment validation workflow.</sub>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
