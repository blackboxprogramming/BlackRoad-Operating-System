name: Label PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Apply file-based labels
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: false

      - name: Label by size
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size-xs'
          xs_max_size: '10'
          s_label: 'size-s'
          s_max_size: '50'
          m_label: 'size-m'
          m_max_size: '200'
          l_label: 'size-l'
          l_max_size: '500'
          xl_label: 'size-xl'

      - name: Label Claude PRs
        if: startsWith(github.head_ref, 'claude/') || github.actor == 'claude-code[bot]'
        run: gh pr edit ${{ github.event.pull_request.number }} --add-label "claude-auto"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Label Atlas PRs
        if: startsWith(github.head_ref, 'atlas/') || github.actor == 'atlas[bot]'
        run: gh pr edit ${{ github.event.pull_request.number }} --add-label "atlas-auto"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Label Codex PRs
        if: startsWith(github.head_ref, 'codex/') || github.actor == 'codex[bot]'
        run: gh pr edit ${{ github.event.pull_request.number }} --add-label "codex-auto"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if docs-only
        id: docs-only
        run: |
          FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path')
          DOCS_ONLY=true

          while IFS= read -r file; do
            if [[ ! "$file" =~ ^docs/ ]] && [[ ! "$file" =~ \.md$ ]] && [[ "$file" != "README"* ]]; then
              DOCS_ONLY=false
              break
            fi
          done <<< "$FILES"

          if [ "$DOCS_ONLY" = "true" ]; then
            gh pr edit ${{ github.event.pull_request.number }} --add-label "docs-only"
            echo "docs_only=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if tests-only
        id: tests-only
        run: |
          FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path')
          TESTS_ONLY=true

          while IFS= read -r file; do
            if [[ ! "$file" =~ /tests/ ]] && [[ ! "$file" =~ test\.py$ ]] && [[ ! "$file" =~ \.test\.(js|ts)$ ]] && [[ ! "$file" =~ \.spec\.(js|ts)$ ]]; then
              TESTS_ONLY=false
              break
            fi
          done <<< "$FILES"

          if [ "$TESTS_ONLY" = "true" ]; then
            gh pr edit ${{ github.event.pull_request.number }} --add-label "tests-only"
            echo "tests_only=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
